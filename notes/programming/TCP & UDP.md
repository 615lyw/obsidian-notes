---
date created: 2022-04-11, 16:22:10
date modified: 2022-08-11, 12:06:21
---

# Meta

- alias:
- parent :: [[传输层]]
- siblings ::
- child ::
- refs: [4.1 TCP 三次握手与四次挥手面试题 | 小林coding](https://xiaolincoding.com/network/3_tcp/tcp_interview.html#tcp-%E5%9F%BA%E6%9C%AC%E8%AE%A4%E8%AF%86)

---

# UDP

- 首部关键字段
    - 源端口号、目标端口号
- 应用：TCP 太复杂，太重了，针对特定的业务场景，应用层会基于 UDP 协议再次开发新协议，以满足自己的业务场景

# TCP VS UDP

- 连接
    - TCP 传输数据前需要建立连接，UDP 无需建立连接，即刻传输数据
- 服务对象
    - TCP 只能是一对一，UDP 可以一对多
- 可靠性
    - TCP 提供可靠交付，UDP 不可靠
- 拥塞控制和流量控制
    - TCP 有拥塞控制，UDP 没有拥塞控制
- 传输方式
    - TCP 面向字节流，UDP 基于数据报

# TCP

## 特点

- 面向连接
    - 通信前要先建立连接，通信结束时要释放连接
    - **双方各自维护一系列状态**
    - 如何唯一确定一个 TCP 连接？
        - 源 IP 地址
        - 源端口号
        - 目标 IP 地址
        - 目标端口号
- 可靠交付：**无差错、不丢失、不重复、按序**
- 全双工通信：有发送缓存区和接受缓冲区
- 面向字节流：Socket 面向应用层输入输出均为流的形式，故无边界，不像 HTTP 以一个完整报文形式呈现

## 首部格式

- 源端口和目标端口号
- 序列号
- 确认应答号：指下一次「期望」收到的数据序列号，发送端收到这个确认应答以后可以认为在这个序号以前的数据都已经被正常接收。用来解决丢包的问题

核心控制位

- 确认位 ACK，控制确认号字段是否有效
- 同步位 SYN，SYN=1 表示这是一个连接请求或连接接受报文
- 复位 RST
- 终止 FIN

**针对服务器监听的某端口，能建立的 TCP 最大连接数是多少？**

目标 IP 和目标端口号是固定的，可变的是源 IP 和源端口号。即最大 TCP 连接数 = 客户端 IP 数 ✖ 客户端端口数。

IPv4，为 32 位；端口号有 16 位，故为 `2^32 * 2^16 = 2^48`

## TCP 连接建立（三次握手）

![[Pasted image 20220811112008.png]]

## 如何在 Linux 系统中查看 TCP 状态？

`netstat -napt`

![[Pasted image 20220811112422.png]]

## 为什么是三次握手？不是两次、四次？

原因：

1. RFC 文档叙述了主要原因：**阻止历史连接的建立**
2. 同步双方初始序列号

四次握手冗余，可合并成三次握手。

两次握手意味着服务端接受到 `SYN` 报文后便进入 `ESTABLISHED` 状态。若为历史 `SYN`，则浪费服务端资源。

## TCP MSS 分片的意义

- 网络层 MTU：
- TCP 层 MSS：

若只采用 MTU 分片，一整块 TCP 数据只有一个序列号，交付给网络层后假设分为了 3 片，若某一片对应的网络包丢失，接收端不会发送确认应答号，TCP 层超时只能重传整块 TCP 数据。

若采用 MSS 分片，一整块 TCP 数据拆分成多个小片，每片都有自己的序列号，若某片丢失，只需重传丢失的那一片。

## TCP 连接断开（四次挥手）

如何实现可靠传输机制？

TCP 可靠传输机制是如何解决可靠传输两个要求？

1. 停止等待（属于自动重传请求 ARQ）
	- 含义
	- 超时重传机制 + 编号
	- 优点简单，缺点信道利用率低
2. 连续 ARQ（属于自动重传请求 ARQ）
	- 含义
	- 滑动窗口（流水线发送）+ 累计确认
3. TCP 实现
