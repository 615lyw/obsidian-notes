---
date created: 2022-06-14, 14:55:20
date modified: 2022-06-14, 16:06:46
---

# Meta

- alias:
- parent :: [[InnoDB 存储引擎]]
- siblings ::
- child ::
- refs: [MySQL 是怎样运行的：从根儿上理解 MySQL - 小孩子4919 - 掘金课程](https://juejin.cn/book/6844733769996304392/section/6844733770046668814)

---

# 索引种类

- 按照物理实现方式分类：
    - 聚簇索引
    - **非聚簇索引（又称为二级索引或辅助索引）**
- 按照功能逻辑分类：
    - 普通索引
    - 唯一索引
    - 主键索引
    - 全文索引
- 按照字段个数分类：
    - 单列索引
    - 联合索引

# 索引底层原理

## 没有索引时如何查找

**在一个页中查找**

- 以主键为搜索条件：在页目录中二分查找快速定位到对应的槽，遍历该槽里所有的记录找到所需记录。
- 以非主键为搜索条件：从最小记录开始遍历数据页单链表中的每条记录。

**在很多页中查找**

1. 定位到记录所在的数据页
2. 在页内进行查找（步骤同在一个页中进行查找）

存在的问题：不管是根据主键还是非主键均不能快速定位记录所在数据页，只能从第一个数据页沿着双向链表一直往下找，在每页使用页内查找方法进行查找，故要遍历所有的数据页。

**问题实质为：如何快速定位记录所在的数据页？**

## 一个简单的索引设计方案

既然没法使用索引的原因在于数据页之间没有规律，故不得不依次遍历所有的数据页，现制定规则如下，以形成数据页之间的规律：

1. 下一个数据页中用户记录的主键值必须大于上一个页中用户记录的主键值
2. 给所有的数据页建立一个目录

**规律一：下一个数据页中用户记录的主键值必须大于上一个页中用户记录的主键值。**

使得数据页也按主键值从小到大排列。

**规则二：给所有的数据页建立一个目录。**

每个数据页对应一个目录项，每个目录项包含两部分：

- 页中用户记录最小的主键值 key
- 页号

最后让**目录项在物理上连续存储**，故可以使用二分查找快速定位某主键所在的数据页。该目录结构即为**索引**。

## InnoDB 索引方案

复用用户记录数据页结构以存放目录项记录 + 建立多级目录结构。

![CleanShot2022-06-14at15.46.18](https://pic-bed-615.oss-cn-beijing.aliyuncs.com/CleanShot%202022-06-14%20at%2015.46.18.png)

最终形成了一棵 B+ 树，特点：

1. 用户记录页和目录项页均满足：
    - 页内的记录按照主键大小顺序排成一个单链表（页内单链表）
    - 页本身也是根据页中记录的主键大小顺序排成一个双向链表（页间双链表）
2. 叶子节点存储的是完整的用户记录

![CleanShot2022-06-14at16.06.23](https://pic-bed-615.oss-cn-beijing.aliyuncs.com/CleanShot%202022-06-14%20at%2016.06.23.png)

上述这种索引和**用户记录**存放在一起的 B+ 树结构称为：**聚集（聚簇）索引**。

## 二级索引（辅助索引）

![CleanShot2022-06-14at16.05.18](https://pic-bed-615.oss-cn-beijing.aliyuncs.com/CleanShot%202022-06-14%20at%2016.05.18.png)

B+ 树索引 = 索引本身 + 叶子节点存储行记录数据。依据叶子节点**是否存储所有**行记录数据可分为：聚集索引和辅助索引。

辅助索引的叶子节点不包含行记录的所有列。

当我们**指定非主键列作为索引时，就是在为该非主键列建立辅助索引**，辅助索引的 B+ 树与聚簇索引的 B+ 树不同点：

1. 使用指定的非主键列（假设为 `c2`）的大小进行记录和页的排序
    - 页内的记录是按照 `c2` 列的大小顺序排成一个单向链表
    - 各个存放用户记录的页也是根据页中记录的 `c2` 列大小顺序排成一个双向链表
2. **叶子节点存储的并不是完整的用户记录，而只是 `c2列+主键` 这两个列的值**
3. 目录项记录中不再是 `主键+页号` 的搭配，而变成了 `c2列+页号` 的搭配

若根据二级索引查找完整的用户记录，由于最终定位到叶子节点时，找到的不是完整的用户记录，而是主键值，故还需要根据找到的主键值再去搜索一遍聚簇索引，即**回表**。

### 联合索引

![CleanShot2022-06-14at16.05.54](https://pic-bed-615.oss-cn-beijing.aliyuncs.com/CleanShot%202022-06-14%20at%2016.05.54.png)

联合索引本质也是一个二级索引。

排序规则：

- 先把各个记录和页按照 `c2` 列进行排序
- 在记录的 `c2` 列相同的情况下，采用 `c3` 列进行排序

**意味着 `c2` 列是全局有序，而 `c3` 列是局部有序。**

## 补充

- B+ 树根页面不会移动：B+ 树生长方向为从上往下
- 二级索引的目录项由 3 部分组成：索引列的值、主键值（用于避免索引列的值相同时，新数据不知道往哪个页面插入）、页号
- 一个页面最少存储两条记录