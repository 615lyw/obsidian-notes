# 什么是微服务？

微服务主要为了解决单体应用的缺点。

服务化思想：把单机应用中的本地方法调用改造成远程方法调用。

把一个业务模块抽取出来，作为一个单独的应用，以单独的进程运行，各服务进程之间通过网络协议实现进程间通信。

# 单体架构与微服务架构

单体架构：所有模块放在一个应用里，跑在一个 Tomcat 中。

缺点：

- 编译测试打包部署效率低、上线时间长
- 系统高可用性差（一个模块挂，所有模块都得挂）

微服务：每个服务可以独立部署和维护。

# 微服务基本组件

## 服务描述

对外：RESTful API
对内：XML 接口配置
跨语言：IDL 文件

## 服务注册与订阅

微服务中的三种角色：
- 服务消费者
- 注册中心：如 [[ZooKeeper]]
- 服务提供者

注册中心即“高德地图”，服务消费者搜索想要的服务，注册中心返回服务的具体地址。

**注册中心原理：**

![](https://pic-bed-615.oss-cn-beijing.aliyuncs.com/z1FyzS.png)

- 服务提供者
	- 启动时根据服务发布文件中配置的信息向注册中心注册服务
	- 定期向注册中心发送心跳汇报存活状态
- 服务消费者
	- 启动时根据服务引用文件中配置的信息到注册中心获取服务节点地址列表缓存在本地内存
	- 基于负载均衡算法选择一个服务提供者节点，与其建立连接
- 注册中心
	- 监控服务提供者状态，若有变化，主动同步给服务消费者，服务消费者刷新本地缓存

**注册中心实现：**

- API
	- 服务订阅、取消订阅
	- 服务注册、反注册
	- 服务查询
	- 心跳汇报
- 集群部署保证高可用
	- 需要解决分布式集群节点数据一致性：Paxos 协议 + ZAB 协议
- 服务提供者健康状态检测：连接会话超时机制
- 服务状态变更通知：Watcher 机制
- 白名单机制

## 服务框架（调用）

如何实现 RPC 远程方法调用？

- 客户端和服务端如何建立网络连接
- 服务端如何处理请求
- 数据传输采用什么协议
- 数据如何序列化和反序列化

## 服务监控

监控服务之间的调用情况，了解服务是否正常提供，用于发现问题。

- 指标收集：收集每一次服务调用的请求耗时以及成功与否，上传至数据中心
- 数据处理：计算指标
- 数据展示

## 服务追踪

用于定位问题。记录服务调用经过的每一层服务节点。

大致原理：知道服务起点和传递顺序（经过的节点顺序）。
- 服务消费者发起调用前，会在本地按照一定的规则生成一个 requestid，发起调用时，将 requestid 当作请求参数的一部分，传递给服务提供者。
- 服务提供者接收到请求后，记录下这次请求的 requestid，然后处理请求。如果服务提供者继续请求其他服务，会在本地再生成一个自己的 requestid，然后把这两个 requestid 都当作请求参数继续往下传递。

## 服务治理

用于解决问题。通过一系列手段保证在各种意外情况下，服务调用正常运行。
