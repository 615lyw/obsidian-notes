---
date created: 2021-10-28, 21:37:05
date modified: 2022-07-13, 18:27:22
---
# Meta

- alias:
- parent ::
- siblings ::
- child ::
- refs:

---

# ZooKeeper

- 开源、为分布式系统提供服务的组件
- 从设计模式角度来说，即观察者模式，数据变化时会主动通知订阅者

## 特点

- 一个 leader，多个 follower 组成的集群
- 集群正常服务需要**半数以上**节点存活
- 全局数据一致：每个 Server 保存一份相同的数据副本
- 来自同一个 Client 的更新请求按发送顺序依次执行
- 数据更新操作具有原子性：客户端的写操作是一个事务

为什么 zk 适合安装奇数台服务器？

**集群正常工作所需最少节点数/总节点数应该尽可能小**。

3/4 (0.75) 3/5 (0.6) 4/6 (0.67) 4/7（0.57）5/8 (0.625) 会发现奇数台时比值要小一些。

## 数据结构

类似 Unix 文件系统，即树形结构，每个节点称为 ZNode，每个节点默认存储 1MB 数据（不能存储海量数据，都是很小的数据量），节点通过路径唯一标识。

## 配置文件参数

- tickTime：zk 客户端和服务端心跳时间，单位毫秒
- initLimit：Leader 与 Follower 初始连接时心跳数限制，假设为 initLimit=10，tickTime=2000，在 `10*2000` 毫秒内若服务端没有接收到客户端心跳则认为连接失败
- syncLimit：Leader 与 Follower 同步通信心跳数限制

## 选举机制

zk 选举机制重要前提条件：配置文件中已经配好了集群节点总数。故每个节点都知道集群半数以上是多少个节点。

节点启动时会发起选举：

新加入的节点可以发起选举，发起选举时，有一张候选票，优先投给自己，再和其他节点交换各自选票情况。
当已经有 Leader 时，Follower 不再改投，新加入的节点少数服从多数，也投给 Leader。（即当集群中已经存在 Leader  时，后加入集群的节点均为 Follower）

节点与 Leader 无法保持连接时，该节点会发起选举：

- 非 Leader 节点离线
- Leader 节点离线

## 监听器

- 监听节点自己数据变化
- 监听子节点增减变化

注册一次，只能监听一次。